<!-- Page HTML Facilitator UI-->
<!doctype html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta charset="utf-8">
    <title>ELC Treasure Hunt: Facilitator</title>
    <meta name="description" content="USC Experiential Learning Center Simulation Game">
    <meta name="author" content="raymondam.com">
    <link rel="icon" href="assets/favicon.png">

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" type="text/css" href="font-awesome-4.2.0/css/font-awesome.min.css">
    <!-- <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/themes/base/jquery-ui.css"> -->

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style type="text/css">
        #table-center {
            text-align: center;
        }

        #canvas {
            width: 100% !important;
            height: 100% !important;
        }
        #wrap {
            min-width: 300px;
            white-space: normal;
        }
        .scrollable-menu {
            height: auto;
            max-height: 400px;
            overflow-x: hidden;
        }
        /* CSS for Footer *************/
        html {
            position: relative;
            min-height: 100%;
        }
        body {
            /* Margin bottom by footer height */
            /*margin-bottom: 60px;*/
        }
        .footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            /* Set the fixed height of the footer here */
            height: 60px;
            background-color: #f5f5f5;
        } 
        body > .container {
            padding: 60px 15px 0;
        }
        .container .text-muted {
            margin: 20px 0;
            text-align: right;
        }

        .footer > .container {
            padding-right: 15px;
            padding-left: 15px;
        }
        code {
            font-size: 80%;
        }
        #chat-messages > *{
            font-size:3vh;
        }
        .text-size{ font-size:3vh; }


        /*#navbar{ height:6vh; }*/
        /*#contents{ height:76vh; }*/
        #timeline-container{ height:10vh; display:flex; flex-direction:columns; margin-bottom:10vh;}
        #chat-container{ width:90vw; margin:auto; }
        /*#site-footer{ height:8vh; }*/
        /* CSS for Footer *************/
    </style>
</head>

<body>
    <nav id="navbar" class="navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <!-- Menu Collapses on Small Screens -->
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                <a class="navbar-brand" href="#">
                    <img alt="Brand" src="assets/ELC_Logo2.png" height="24px" width="300px">
                </a>
            </div>

            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li style="cursor:grab"><a>Treasure Hunt Simulation</a></li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a>Logged in as <strong><?PHP echo $_SESSION['user']['username']?></strong></a></li>
                    <li><a href="multimedia_config.php" target="_blank">Administration Panel</a></li>
                    <li><a href="logout.php">Logout</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                            <span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
                        </a>
                        <ul class="dropdown-menu scrollable-menu" role="menu">
                            <li>
                                <a>
                                    <h4>Objective</h4>
                                    <p id="wrap">
                                        Make as much money as possible.
                                    </p>
                                </a>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <a>
                                    <h4>Expenses</h4>
                                    <p id="wrap">You start with a budget of $1200. </p>
                                    <p id="wrap">Partaking of food and water is free while staying at Trojan Island, but food intended to take on the trip must be purchased. Water is free to fill barrels at all Islands, including Trojan Island.</p>
                                    <p id="wrap">One Unit (enough for your team for a day) of food costs $25 at Trojan Island and $50 at all other islands.</p>
                                    <p id="wrap"> One day of gas for travel is $50 at Trojan Island and $100 at all other islands. If you don’t travel on a day, you don’t consume gas.</p>
                                </a>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <a>
                                    <h4>Treasure</h4>
                                    <p id="wrap">The winning team is the team with the most money at the end (unspent budget + treasure).</p>
                                    <p id="wrap">One unit of treasure is obtained for each day spent at the Treasure Spot.</p>
                                    <p id="wrap">Each treasure unit is worth $13,000 on the day the first ship returns to Trojan Island.</p>
                                    <p id="wrap">Each treasure unit is worth $12,000 one day after the first ship returns to Trojan Island.</p>
                                    <p id="wrap">Each treasure unit is worth $11,000 2 days after the first ship returns to Trojan Island (the price continues to drop each day later).</p>
                                    <p id="wrap">Treasure can be sold at all islands. However, each treasure unit is only worth $5000 at all islands other than Trojan Island (price doesn’t fluctuate).</p>
                                </a>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <a>
                                    <h4>Cautions</h4>
                                    <p id="wrap">If you run out of food or water, you will only be able to move 1/2 your intended distance. If you run out of both food and water, you will move 1/4 the distance.</p>
                                    <p id="wrap">Absolutely do not run out of gas. If you run out of gas, then you die unless another team saves you within 3 days.</p>
                                    <p id="wrap">Storage is limited. You only have enough space (available weight) to store 30 units combined (units can be water, food, gas).</p>
                                    <p id="wrap"><strong>Rain:</strong> If you end up staying the night in open water, you will use up two days worth of water, food, and gas for that one day. (i.e. the only way to avoid penalty is to be headed toward an island).</p>
                                    <p id="wrap"><strong>Pirates:</strong> Pirates may attack your ship in open water, their base island, but never at the treasure spot. (In other words, direct one day travel from one island to another is perfectly safe). Pirates will take half your gas, all food and all treasure.</p>
                                    <p id="wrap">You may speak with "CRUSTY OLD SEA CAPTAIN". It's free, but you must stay at the location to speak for the entire day.</p>
                                    <p id="wrap">The "CRUSTY OLD SEA CAPTAIN" claims to know about weather and pirates, but loves company and will only talk about one issue per day (to encourage you to stick around for an extra day to talk).</p>
                                    <p id="wrap">The "CRUSTY OLD SEA CAPTAIN" has made dinner reservations at a favorite restaurant on Trojan Island for day 1. Once on Trojan Island, the Captain will stay for 2 days and then head toward Sun Devil Island. The Captain will head back to Trojan Island on day 8.</p>
                                    <p id="wrap">Trojan Island (home) and Sun Devil Island are the only islands with sophisticated communication capability. Teams have the ability to contact someone at each island.</p>
                                    <p id="wrap">If two teams are in the same location, they are free to speak to each other.</p>
                                </a>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <a>
                                    <h4>Reporting Procedure</h4>
                                    <p id="wrap">Each day consists of 3 minutes of real time. (May be adjusted as winter approaches.)</p>
                                    <p id="wrap">Each day, outcomes are calculated and the decision of where to move for the next day is recorded on the team’s spreadsheet.</p>
                                    <p id="wrap">Then, once the new day arrives, the weather is announced and calculations can be done and so on.</p>
                                    <p id="wrap">Please note that supplies can be purchased but not consumed on the same day.</p>
                                    <p id="wrap">Treasure is acquired on the day when you arrive on the treasure spot, but not on the day that you are leaving the treasure spot.</p>
                                    <p id="wrap">Teams can merge, but the final results are calculated by taking average net value for the teams.</p>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Alert Insertion -->
    <div id="alert-insert"></div>

    <div id="contents" class="container-fluid">
        <div class="row" >
            <form action="?" method="POST">
                <!-- Left Side -->
                <div class="col-md-8" id="stats">
                    <H3 align="center" style="padding-bottom:10px;">Player Statistics</H3>
                    <!-- Scrollable Table -->
                    <div style="height: 400px; overflow:auto; font-size:2.5vh">
                        <table class="table table-striped" id="player-table">
                            <tr>
                                <th id="table-center">Active?</th>
                                <th id="table-center">Player</th>
                                <th id="table-center">Cash</th>
                                <th id="table-center">Current Location</th>
                                <th id="table-center">Food</th>
                                <th id="table-center">Water</th>
                                <th id="table-center">Gas</th>
                                <th id="table-center">Cash</th>
                                <th id="table-center">Ready?</th>
                            </tr>
                        </table>
                    </div>

                </div>

                <!-- Right Side -->
                <div class="col-md-4" id="score">
                    <!-- Graph -->

                    <h3 align="center" onclick="hideOtherComp()" style="cursor:zoom-in;">Cash per Player</h3>

                    <div class="row" onclick="hideOtherComp()" style="cursor:zoom-in;">
                        <!-- adjust chart size -->
                        <div class="col-md-12" id="canvas-container" style="height:400px">
                            <!-- Load Chart. See JS. -->
                            <canvas id="canvas" height="auto" width="auto"></canvas>
                        </div>
                    </div>

                    <div class="row">
                    </div>
                </div>

                <!-- button group container -->
                <div id="button-group-container" class="container-fluid">
                    <div class="col-md-4">
                        <br>
                        <button type="button" class="btn btn-primary btn-danger btn-block text-size" onclick="resetAlert()">Reset Player Group</button>
                    </div>
                    <div class="col-md-4">
                        <br>
                        <button type="button" class="btn btn-primary btn-success btn-block text-size" id="advance-btn" onclick="advSim()">Advance Simulation to Next Day</button>
                        <br>
                        <div id="override-btn"></div>
                        <!-- Insert Override Button for when less rooms are used -->
                        <div id="trade-in-progress"></div>
                    </div>
                    <div class="col-md-4">
                        <br>
                        <button id="chatOpenButton" type="button" class="btn btn-info btn-block text-size" data-toggle="collapse" data-target="#chat-container" onclick="changechatbuttontext()">Open Chat</button>
                    </div>
                </div>

                <!-- chat now pops up on bottom -->
                <div  id="chatR">
                    <!-- chat -->
                    <div id="chat-container" class="collapse">
                        <h3 align="center">Chat Room</h3>
                        <div class="row">
                            <div class="panel panel-info" id="chat-panel" style="overflow-y: scroll;height:400px;">
                                <!-- message panel -->
                                <div id="chat-messages">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-13">
                                <div class="input-group">
                                    <input style="font-size:3vh; height:6vh;" type="text" class="form-control" id="chat-message-input" name="chat-message-input" autocomplete="off" placeholder="Say something...">
                                    <span class="input-group-btn">
                                        <button style="font-size:3vh;" type="button" class="btn btn-primary btn-block" id="chat-send-button">Send</button>  
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>    
        <br/>
    </div>
    <!-- Timeline -->
    <div id="timeline-container" class="row" style="width:100%">
        <div style="width:100%;">
            <div class="progress" style="align-self:center; height:100%; width:100%">
                <div class="progress-bar progress-bar-warning" id="timeline-planning" role="progressbar" aria-valuenow="5.26" aria-valuemin="0" aria-valuemax="100" style="width: 5.26%;  font-size:3vh; height:100%; display: table;">
                    <p style="display: table-cell; vertical-align: middle;">Planning Period</p>
                </div>
                <div class="progress-bar progress-bar-danger" id="timeline-day" role="progressbar" aria-valuenow="5.26" aria-valuemin="0" aria-valuemax="100" style="width: 5.26%;  font-size:3vh; height:100%; display: table;" >
                    <p style="display: table-cell; vertical-align: middle;">Day 1</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Overlay at End of Simulation (called when day = 13) -->
    <div class="modal fade bs-example-modal-lg" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">End of Simulation</h4>
                </div>
                <div class="modal-body">
                    <p>Please reset the simulation to start again.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Site Footer -->
  <footer id="site-footer" class="footer row-md-2">
  	<div class="container pull-right">
  		<p class="text-muted"><i class="fa fa-copyright"></i> 2018 University of Southern California Marshall School of Business. All rights reserved. | <span style="cursor:pointer" onclick="showCredits()">Credits</span></p>
  	</div>
    <div class="modal fade bs-example-modal-lg" id="credits-modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Credits</h4>
                </div>
                <div class="modal-body">
                    <p>
                        Original design by Raymond Dam in 2012.
                        <br/><br \>
                        Design expanded into 2D game in 2016 by Ford Filer, Henry Liu, Dean Hutkin, Yuan Fu, and Yimin Jia.
                        <br/><br />
                        The game experienced a major upgrade in 2018 through work done by James Lee, Phillip Nazarian, and Ahsan Zaman. 3D graphics, a revamped server, and a more user-friendly design along with many other design elements were introduced.
                    </p>
                </div>
            </div>
        </div>
    </div>
  </footer> 

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
  integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
  crossorigin="anonymous"></script>
    <!-- Chart.js -->
    <script src="Chart.js-master/Chart.js"></script>
    <!-- Include socket.io plugin libraries -->
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <!-- Page Javascript -->
    <script type="text/javascript">
    	//Global Variables
    	var override = 0;
        var username = "Facilitator";
        var userGrouping = "<?PHP echo $_SESSION['user']['grouping']; ?>";
        //var userGrouping = "test"; //Need to come back and change this
        var socket = {};
		var trades = [];
		var deadPlayers = {};
		var activePlayers = {};
		var firstLoad = true;
        //discourage refreshing the page
        window.onbeforeunload = function() {
            return "WARNING! Refreshing may result the lost of progress.";
        }
    	//**************************
        window.onload = function() {
            //get data
            // intitData();
            testing_init();
    //         $(function () {
    //             //Setup socket.io for chat functionality
    //             console.log("running js");
				// if(window.location.hostname == "localhost")
				// {
				// 	socket = io("localhost:3000");
				// }
				// else
				// {
				// 	socket = io(window.location.hostname);
				// }
    //             socket.on('connect', handleConnection);
				// socket.on('reset', handleReset);
    //             socket.on('message', handleNewMessage);
				// socket.on('sos', handleSOS);
				// socket.on('tradeInit', showTradeInProgress);
				// socket.on('tradeEnd', removeTradeInProgress);

    //             $("#chat-send-button").click(sendChatMessage);
    //             $('#chat-message-input').keypress(function (e) {
    //                   if (e.which == 13) {
    //                     sendChatMessage();
    //                     return false;    //<---- Add this line
    //                   }
    //             });
    //         });
        };
        function showCredits(){
            $( "#credits-modal").modal("show");
        }
		
		function handleSOS(data){
			//console.log("Got Message2: " + data.msg);
			var msgHTML = '<font color = \"red\">' + data.msg + '</font></br>';
			$("#chat-messages").append(msgHTML);
			$("#chat-panel").scrollTop($("#chat-panel")[0].scrollHeight);
		}
        function changechatbuttontext(){
            if($('#chatOpenButton').html() == "Open Chat"){
                $('#chatOpenButton').html("Close Chat");
                $('html,body').animate({scrollTop: document.body.scrollHeight},"fast");
            }
            else{
                $('#chatOpenButton').html("Open Chat");
            }
        }
        //chat functions
        function handleConnection(){
            var connectedMsg = "Facilitator is connected.";
            var messageObj = {msg: connectedMsg, grouping: userGrouping, username: username};
            console.log(connectedMsg);
            socket.emit("newClient", messageObj);
        }
		
		function handleReset()
		{
			$("#chat-messages").empty(); 
		}
 
        function handleNewMessage(messageObj){
			var data = messageObj.sender + ": " + messageObj.msg;
            console.log("Got Message: " + data);
            var msgHTML = "<span class=\"message\">" + data+ "</span><br>";
            $("#chat-messages").append(msgHTML);
            $("#chat-panel").scrollTop($("#chat-panel")[0].scrollHeight);
        }


		function showTradeInProgress(tradeObj)
		{
			if(tradeObj)
			{
				trades.push(tradeObj);
			}
			$("#trade-in-progress").empty();
			for(var it in trades)
			{
				var trade = trades[it];
				$("#trade-in-progress").append("<span>Note: There is a trade in progress between " + trade.sender + " and " + trade.receiver + "</span></br>");
			}
		}
		
		function removeTradeInProgress(tradeObj)
		{
			console.log("Remove");
			console.log(tradeObj);
			for(var i = 0; i < trades.length; i++)
			{
				var curTrade = trades[i];
				if(tradeObj.partner == curTrade.sender)
				{
					trades.splice(i, 1);
					break;
				}
			}
			showTradeInProgress();
		}
        function sendChatMessage(){
            var chatInput = $("#chat-message-input"); 
            var message = chatInput.val();
            var receiver = "All";
            var messageType = (receiver == "All")? "broadcast":"direct";
            var messageObj = {msg: message, grouping: userGrouping, sender: username, receiver: receiver, type: messageType};
            if(chatInput.val() != "")
            {
                socket.emit("message", messageObj);
            }
            
            chatInput.val("");
        }
		function clearTable()
		{
			$('#player-table').html(
				'<tr>' +
					'<th id="table-center">Active?</th>' +
					'<th id="table-center">Player</th>' +
					'<th id="table-center">Cash</th>' +
					'<th id="table-center">Location</th>' +
					'<th id="table-center">Food</th>' +
					'<th id="table-center">Water</th>' +
					'<th id="table-center">Gas</th>' +
					'<th id="table-center">Treasure</th>' +
					'<th id="table-center">Ready?</th>' +
				'</tr>'
			);
		}
        //for testing purposes only
        function testing_init(){
            var users = [   // [username, cash, current_loc, food, water, gas, ready, treasure]
                            ['Ship B',100,'trojan-island',4,4,4,1,4],
                            ['Ship C',100,'trojan-island',4,4,4,1,4],
                            ['Ship D',100,'trojan-island',4,4,4,1,4],
                            ['Ship E',100,'trojan-island',4,4,4,1,4],
                            ['Ship F',100,'trojan-island',4,4,4,1,4],
                            ['Ship G',100,'trojan-island',4,4,4,1,4],
                            ['Ship H',100,'trojan-island',4,4,4,1,4],
                            ['Ship I',100,'trojan-island',4,4,4,1,4]
                        ];
            var day = 0;
            genGraph(users.map(x=> x[0]), users.map(x => x[1]));
            timeline(day);
            for(i=0; i<8; i++){
                newRow(users[i][0], users[i][1], users[i][2], users[i][3], users[i][4], users[i][5], users[i][6], users[i][7]); 
            }
            
            var msg1 = "Hello there!"
            var msgHTML1 = "<div class='row-fluid' style='border-bottom:1px solid black; display:flex; margin:0;'>\
                                <div class='col-md-2 row-eq-height' style=\"text-align:center; font-weight:bold; background-color:#E1EFE6;\">C&nbsp;<span class=\"glyphicon glyphicon-arrow-right\"></span>&nbsp;D&nbsp;</div>\
                                <div class='col-md-10 row-eq-height' style='background-color:#EFCB68;'>" + msg1 + "</div>\
                            </div>";
            $("#chat-messages").append(msgHTML1);
        }
        //call server for initial data
        function intitData() {
        	//Reset some elements to their baseline
				clearTable();
        	//*********************************
            xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function() {
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    var userTable = JSON.parse(xmlhttp.responseText);

                    var usernames = new Array();
                    var cash = new Array();
                    var counter = 0;
                    var once = 0;
                    var day = 0;

                    for(i = 0; i < userTable.length; i++) {

                    	//only show players in admin's group
                    	if("<?PHP echo $_SESSION['user']['grouping']; ?>" == userTable[i]['grouping']) {
							if(firstLoad)
							{
								activePlayers[userTable[i]['username']]  = true;
							}
							if(userTable[i]['days_out_of_fuel'] >= 3)
							{
								userTable[i]['cash'] = 0;
							}
	            			//table
	                    	newRow(
	                    		userTable[i]['username'], userTable[i]['cash'], userTable[i]['current_loc'], 
	                    		userTable[i]['food'], userTable[i]['water'], userTable[i]['gas'], "<i class='fa fa-remove fa-lg'></i>", userTable[i]['treasure']
	                    	);
	                    	//data for graph
	                    	usernames[counter] = userTable[i]['username'];
	                    	cash[counter] = userTable[i]['cash'];
	                    	counter++;

	                    	if(once == 0) {
	                    		day = userTable[i]['day'];
	                    		once = 1;
	                    	}
                    	}                    		
                	}
                    //graph
                    genGraph(usernames, cash);
                    //timeline
                    timeline(day);

                    //END OF SIMULATION: If day 14, then disable all entry and show modal
                    if(day == 15) {
                    	//Disable Simulation Advance button
                    	$('#advance-btn').prop('disabled',true);

                    	//Show modal alert to user
                    	$('#myModal').modal('show');
                    }
					firstLoad = false;
                }
            }
            xmlhttp.open("GET","facilitator_response.php?token="+"<?PHP echo $_SESSION['user']['token']; ?>",true);
            xmlhttp.send();
        }
        //poll server until all players have submited their decisions
        function pollData() {
        	//maintain variable through multiple polls
        	var once = 0;
            var playerNum = 0;

            //poll server as players submit
        	var polling = setInterval(function() {
	            xmlhttp2 = new XMLHttpRequest();
	            xmlhttp2.onreadystatechange = function() {
	                if (xmlhttp2.readyState == 4 && xmlhttp2.status == 200) {
	                    var userTable = JSON.parse(xmlhttp2.responseText);

			            var usernames = new Array();
			            var cash = new Array();
			            var playersReady = 0;
			            var counter = 0;	                    

		        		clearTable();

			            for(i = 0; i < userTable.length; i++) {
	                    	//only show players in admin's group
	                    	if("<?PHP echo $_SESSION['user']['grouping']; ?>" == userTable[i]['grouping']) {
	                    		//how many players in group? do this only once
	                    		if(once == 0) {
	                    			playerNum++;
	                    		}
	                    		//check ready state to display correct icon
	                    		var readyState = "<i class='fa fa-remove fa-lg'></i>";
								
								if(!activePlayers[userTable[i]['username']])
								{
									playersReady++;
									var readyState = "<i class=''>Inactive</i>";
								}
								else if(userTable[i]['ready'] == 0 || userTable[i]['days_out_of_fuel'] >= 3) {
									if(userTable[i]['days_out_of_fuel'] >= 3)
									{
										readyState = "<i class=''>Dead</i>"; 
										userTable[i]['cash'] = 0;
										deadPlayers[userTable[i]['username']] = true;
									}
									else
									{
										readyState = "<i class='fa fa-check fa-lg'></i>"; 		
										deadPlayers[userTable[i]['username']] = false;
									}
	                    			playersReady++;                   			
	                    		}
								
								
		            			//table
		                    	newRow(
		                    		userTable[i]['username'], userTable[i]['cash'], userTable[i]['current_loc'], 
		                    		userTable[i]['food'], userTable[i]['water'], userTable[i]['gas'], readyState,userTable[i]['treasure']
		                    	);
		                    	//data for graph
		                    	usernames[counter] = userTable[i]['username'];
		                    	cash[counter] = userTable[i]['cash'];
		                    	counter++;              		
	                    	}                    		
	                	}
	                	//playernum is update in only one poll
	                	once = 1;

	                	//if all players are ready, then end the polling and reset button
	                	if(playerNum == playersReady) {
	                		//change button
		                    $('#advance-btn').removeClass('btn btn-primary btn-danger btn-block');	//change color
		                    $('#advance-btn').addClass('btn btn-primary btn-success btn-block');
		                    $('#advance-btn').html('Advance Simulation to Next Day');       		//change btn text
		                    $('#advance-btn').removeAttr('disabled');
	                		
	                		//remove override button
	                		$('#override-btn').html('');
		                    
		                    //reload data
		                    intitData();

	                		clearInterval(polling);
							trades = [];
	                	}
			        }			        
		        }
	            xmlhttp2.open("GET","facilitator_response.php?token="+"<?PHP echo $_SESSION['user']['token']; ?>", true);
	            xmlhttp2.send();		        
            }, 5000);
        }
		function toggleActive(username)
		{
			if(activePlayers[username])
			{
				activePlayers[username] = false;
			}
			else
			{
				activePlayers[username] = true;
			}
		}
        //helper function that preps table entries
        function newRow(username, cash, current_loc, food, water, gas, ready, treasure) {
			if(deadPlayers[username])
			{
				ready = "<i>Dead</i>";
			}
			if(!activePlayers[username])
			{
				ready = "<i>Inactive</i>";
			}
			if(activePlayers[username])
			{
				var activeHTML = "<input type=\"checkbox\" checked onclick=\"toggleActive('"+username+"');\">";
				
			}
			else
			{
				var activeHTML = "<input type=\"checkbox\" onclick=\"toggleActive('"+username+"');\">";
			}
			
        	$('#player-table').append(
	            "<tr>" +
					"<td id='table-center'>"+ activeHTML + "</td>" +
	                "<td id='table-center'>" + username + "</td>" +
	                "<td id='table-center'>" + cash + "</td>" +
	                "<td id='table-center'>" + current_loc + "</td>" +
	                "<td id='table-center'>" + food + "</td>" +
	                "<td id='table-center'>" + water + "</td>" +
	                "<td id='table-center'>" + gas + "</td>" +
					"<td id='table-center'>" + treasure + "</td>" +
	                "<td id='table-center'>" + ready + "</td>" +
	            "</tr>"
        	);
        }
        //helper function that generates graph
        function genGraph(username, cash) {
	        var data = {
	            labels: username,
	            datasets: [
	                {
	                    label: "Cash per Player",
	                    fillColor: "rgba(151,187,205,0.5)",
	                    strokeColor: "rgba(151,187,205,0.8)",
	                    highlightFill: "rgba(151,187,205,0.75)",
	                    highlightStroke: "rgba(151,187,205,1)",
	                    data: cash
	                }
	            ]
	        };
            //clear canvas before graphing
            $('#canvas').remove();
            $('#canvas-container').append('<canvas id="canvas" height="100%" width="100$"></canvas>');

	        var ctx = document.getElementById("canvas").getContext("2d");
            Chart.defaults.global.defaultFontSize = '30';
            window.myBar = new Chart(ctx).Bar(data, {
                responsive : true,
                fontSize: 40
            });
        }
        //functionality for reset button
        function resetAlert() {
        	//display confirmation alert
        	$("#alert-insert").append(
        		'<div class="alert alert-danger alert-dismissible fade in" role="alert" style="text-align:center;">' +
    			     '<H4>Player Reset Confirmation</H4>' +
    			     '<p>Are you sure you want reset all players in your group?</p>' +
    				'<button type="button" class="btn btn-danger" data-dismiss="alert" aria-label="Close"onClick="resetPlayers()" style="margin-right:1vw;">Reset</button>' +
    				'<button type="button" class="btn btn-primary" data-dismiss="alert" aria-label="Close" class="col-md-6" style="margin-left:1vw;">Cancel</button>' +
        		'</div>'
        	);
        }
        //helper function for Timeline: takes in day (-3 to 14)
        //moves progress by increments of 5.26
        function timeline(day) {
            var counter = 1;
            for(i = -3; i <= day; i++) {
                var temp = 5.26 * counter;
                //move planning period bar from day -3 to 0
                if(i <= 0) {
                    $('#timeline-planning').attr('aria-valuenow', temp);
                    $('#timeline-planning').css('width', temp+'%');
                    //reset counter after day 0
                    if(i == 0) {
                        counter = 1;
                    }
                } 
                //move day bar after
                else {
                    $('#timeline-day').removeAttr('hidden');
                    $('#timeline-day').attr('aria-valuenow', temp);
                    $('#timeline-day').css('width', temp+'%');
                    $('#timeline-day').html('Day ' + day);
                }
                counter++;
            }
        }      
        //helper function to manually end polling. For runs that use less than all rooms in group.
        function overrideButton() {
        	//change internal text
        	$('#override-text').html('<i class="fa fa-spinner fa-spin"></i> Please Wait...');        	
        	//Calls DB to close all submissions
            // $.ajax({
            //     url: 'facilitator_submitkill.php',
            //     type: 'POST',
            //     data: {'token' : "<?PHP echo $_SESSION['user']['token']; ?>"},

            //     success: function(data) {
            //     	//do nothing
            //     },

            //     error: function(e) {
            //         console.log(e);
            //     }
            // });        	
        }
        //AJAX call to reset player values
        function resetPlayers() {
     //        $.ajax({
     //            url: 'facilitator_reset.php',
     //            type: 'POST',
     //            data: {'token' : "<?PHP echo $_SESSION['user']['token']; ?>"},

     //            success: function(data) {
     //            	//reenable the advance simulation button you disabled at the end of the simulation
     //            	$('#advance-btn').removeAttr('disabled');

     //                //reset timeline
     //                $('#timeline-day').attr('aria-valuenow', 0);
     //                $('#timeline-day').css('width','0%');                    

     //            	//reload data
     //            	intitData();
					
					// //Reset the chat server
					// socket.emit("reset", {grouping: userGrouping});
					// handleReset();
     //            },

     //            error: function(e) {
     //                console.log(e);
     //            }
     //        });
        }
        //advance by one day
        //update the ready boolean for all users in the admin's group
        //poll server until all users have submitted
        function advSim() {
			$('#advance-btn').prop('disabled',true);
            // $.ajax({
            //     url: 'facilitator_advance.php',
            //     type: 'POST',
            //     data: {'token' : "<?PHP echo $_SESSION['user']['token']; ?>"},

            //     success: function(data) {
            //     	//change button
   
            //         $('#advance-btn').removeClass('btn-success');             					//change color
            //         $('#advance-btn').addClass('btn btn-primary btn-danger btn-block');
            //         $('#advance-btn').html('<i class="fa fa-refresh fa-spin"></i> Waiting for Player to Submit...');       	//change btn text

            //         //insert override button
            //         $('#override-btn').html('<button type="button" class="btn btn-primary btn-danger btn-block text-size" id="override-text" onclick="overrideButton()">End Submission (Manual Override)</button><br>');

            //     	//call function to begin polling
            //     	pollData();
            //     },

            //     error: function(e) {
            //         console.log(e);
            //     }
            // });
        }

        function hideOtherComp(){

            //case hide
            if($('#chatR').is(":visible")){

                $('#chatR').hide();
                $('#stats').hide();
                $('#button-group-container').hide();
				
                $('#score').removeClass('col-md-4').addClass('col-md-12');
                window.myBar.resize(window.myBar.render, true);
                window.myBar.render();

                $('#hide-btn').text("Show Entire Dashboard"); 

            }

            //case show
            else 
			{
                $('#score').removeClass('col-md-12').addClass('col-md-4');
                $('#chatR').show();
                $('#stats').show();
				$('#button-group-container').show();
                window.myBar.resize(window.myBar.render, true);
                window.myBar.render();

                $('#hide-btn').text("Show Only Chart"); 

            }



        }
    </script>
</body>
